; 煤矿瓦斯风险预测系统配置文件
; 版本: 1.0
; 最后更新: 2025-10-15
[Model]
# 模型存储目录
model_dir = models
# 算法选择：lightgbm 或 xgboost
algorithm = lightgbm
# 全量训练触发阈值（样本数）
full_train_threshold = 200
# 最小训练样本数
min_train_samples = 5
# 初始树数量（控制模型基础拟合能力，欠拟合可增大）
n_estimators = 200
# 增量训练每次增加的树数量（增量更新强度，不足可增大）
increment_estimators = 20
; LightGBM核心参数（影响模型拟合能力，重点调优项）
; 单棵树的最大叶子数（叶子节点数，欠拟合增大，过拟合减小）
num_leaves = 63
; 学习率（步长，过小收敛慢，过大易震荡，建议0.01-0.1）
learning_rate = 0.03
; L1正则化（抑制过拟合，值越大惩罚越强）
reg_alpha = 1.0
; L2正则化（抑制过拟合，值越大惩罚越强）
reg_lambda = 2.0
; ===== LightGBM 过拟合抑制（新增项）=====
; 最大深度（LightGBM同样支持；配合num_leaves限制复杂度）
max_depth = 6
; 每个叶子最小样本数（强烈建议：抑制记忆噪声/过拟合）
min_data_in_leaf = 60
; 特征采样比例（增加随机性，提升泛化）
feature_fraction = 0.85
; 样本采样比例（bagging）
bagging_fraction = 0.85
; 每隔多少轮进行一次bagging（>0时才生效）
bagging_freq = 1
; XGBoost核心参数
; 子采样比例（防止过拟合，典型值0.7-1.0）
subsample = 0.7
; 特征采样比例（防止过拟合，典型值0.7-1.0）
colsample_bytree = 0.7
;过拟合/欠拟合判断阈值（解决硬编码问题） +++
overfitting_threshold = 2.0
# 数据量充足时的欠拟合阈值
underfitting_large_threshold = 1.0
# 数据量较小时的欠拟合阈值
underfitting_small_threshold = 1.2
# 增量训练窗口最大样本条数（防止窗口过大）
incremental_window_limit = 5000
# 增量训练窗口：递进 lookback（10→14→21）
incremental_lookback_days_schedule = 10,14,21
# 每累计这么多样本，lookback 升级一档（按你日增 150~300，建议 1000~2000）
incremental_lookback_step_samples = 1500
# ========= 增量训练窗口参数（全量/常规模式） =========
# 当增量训练批次只有1天数据时，从DB回捞最近N天样本拼训练窗口
# 兜底：如果不想用 schedule，也至少保留这个
incremental_lookback_days = 14
# 仅训练阶段平滑 q（不改入库原始样本）
smooth_q_target = false
# q 平滑强度：0.15~0.30 常用；越小越平滑
q_smooth_alpha = 0.22



[Database]
; ===== 数据库类型切换（mysql / sqlite）=====
; 默认 mysql：保持原系统行为不变
db_type = mysql
; sqlite 文件路径（db_type=sqlite 时生效；可相对路径）
sqlite_path = data/hhhz-dzrj.db
#数据库主机地址
host = localhost
#数据库端口
port = 3306
#数据库用户名
user = root
#数据库密码
password = 123456
#数据库名称
db_name = hhhz-dzrj
charset = utf8mb4

[Server]
#服务绑定地址（0.0.0.0允许外部访问）
host = 0.0.0.0
#服务端口
port = 5000
#是否开启调试模式（生产环境设为false);
debug = false

[ModelEval]
# 小数据量判断阈值（低于此值跳过性能检查）
small_data_threshold = 10
# 中等数据量判断阈值（放宽性能检查）
medium_data_threshold = 20
; ===== 发布策略（Publish Policy）=====
; 若线上尚无已发布模型：首个评估可信(success 且非 evaluation_invalid) 的模型直接发布
publish_first_success = true
; 线上已有模型时：允许相对 baseline 的最大劣化比例（0.0 表示不允许变差；0.01 表示允许差1%仍可发布）
publish_allow_degrade_pct = 0.0
; ===== 评估集去泄漏（新增）=====
; time_holdout 时，尽量选择训练期未出现过的 group（避免泄漏）
group_holdout_enabled = true
; 评估分组键：优先 spatiotemporal_group，其次 coord_hash
eval_group_key = spatiotemporal_group
; 当日期跨度太短（span_days < holdout_days 或 uniq_dates<=2）时，time_holdout自动降级为 latest + group去重
short_span_backoff = true
; latest/回退路径以及holdout内部：按 group 去重，同一 group 只保留最近一条
eval_dedupe_by_group = true
# 评估集切分策略：latest | time_holdout
eval_split_mode = time_holdout
# 留出最近多少天作为评估集（time_holdout 生效时使用）
holdout_days = 3
# time_holdout 最少评估样本数，不足则自动回退为 latest
min_holdout_samples = 50
# 评估样本数量（从数据库读取最新 eval_size 条）,根据实际情况的样本数量级调整
eval_size = 200
# 性能下降阈值（相对于基线的比例，例如 0.10 = 10%）
perf_drop_ratio = 0.25
# 连续多少次评估确认下降（用于去抖）
perf_window = 2
# 聚合权重（2个目标）
agg_weights = 1,1



[Logging]
# 保留最近多少个备份
keep_backups = 10
# 最大训练记录数
max_training_records = 1000
# 是否显示详细控制台输出
verbose_console = true
# 日志级别（DEBUG/INFO/WARNING/ERROR）
log_level = info
# 训练日志简略显示:true精简/false详细
brief_training_logs = true
log_dir = logs

[Features]
# 基础分类特征（用逗号分隔）
base_categorical = working_face,work_stage,roadway,roadway_id,borehole_id
# 基础数值特征（用逗号分隔）
base_numeric = distance_from_entrance,x_coord,y_coord,z_coord,coal_thickness,regional_measure_strength,drilling_depth,distance_to_face,face_advance_distance
# 预测目标特征（用逗号分隔），移除了,gas_analysis_index_dh2特征
target_features = drilling_cuttings_s,gas_emission_velocity_q
# 动态数据库字段映射（字段名:数据类型，用分号分隔）
dynamic_db_columns = measurement_date:DATE;work_stage:VARCHAR(20);advance_rate:FLOAT;coord_hash:VARCHAR(100);gas_emission_q_diff:FLOAT;drilling_cuttings_s_diff:FLOAT;gas_emission_velocity_q_diff:FLOAT

[SpatioTemporal]
# 坐标分桶精度：round(1)=0.1m；round(0)=1m
coord_round = 1
# 距采面距离分桶（m），建议1~2m；设置为0表示不分桶
distance_to_face_bucket = 2
# 历史统计分组策略：
# coord：仅按坐标分组（兼容旧逻辑）
# coord_distance：按坐标+距采面距离分组（推荐，避免工况混淆）
history_group_mode = coord_distance
; ===== 历史种子（seed）控制参数 =====
; 每个 group 取多少条历史记录作为种子（建议 10~50；过大会爆量并污染趋势）
history_seed_limit = 20
; 只回捞最近 N 天的历史（避免远古数据污染趋势）
history_seed_lookback_days = 30
; 去重聚合：同一 group 同一天多条记录取均值（强烈建议开启）
history_seed_dedupe_by_date = true
# q 滑动均值窗口（按你 150~300/天，隔天采：5~9 比较合适）
q_roll_window = 5
# 融合权重：rolling 权重（0~1），越大越“稳”
q_roll_weight = 0.65
# advance_rate（推进速率）的计算口径：用于生成增强特征并参与评估“输入是否可信”。
# 重要：当 distance_to_face 表示“孔深/距工作面法向距离(2/3/…/10m)”时，
#       不应再用 distance_to_face 计算推进速率，否则 advance_rate 会长期为0，导致 evaluation_invalid。
# 可选值（字段名或别名）：
#   - face_advance_distance（默认，推荐：累计推进/进尺）
#   - distance_from_entrance（推荐：巷道进尺/位置）
#   - distance_to_face（仅当你明确把它定义为“进尺/推进尺度”时使用）
# 别名：advance/face -> face_advance_distance；entrance/from_entrance -> distance_from_entrance；to_face -> distance_to_face
advance_rate_source_mining = face_advance_distance
advance_rate_source_other  = face_advance_distance



[SourcePrediction]
# 分源预测法配置
default_coal_density = 1.4
base_initial_gas_emission = 0.01

# 断层影响系数计算配置（参考煤矿安全文献《断层对瓦斯涌出影响的量化分析》）
[FaultParams]
# 基础影响系数（无断层时默认值）
base_strength = 0.5
# 距离衰减系数（距离越大，影响越小）
distance_decay = 0.8
# 断层类型权重（1=正断层，2=逆断层）
fault_type_weight_1 = 1.2
fault_type_weight_2 = 0.8
# 断距权重系数（断距越大，影响越大）
fault_height_weight = 0.15
# 断层长度权重系数（长度越大，影响越大）
fault_length_weight = 0.1
# 倾角权重系数（倾角90°时影响最大，0°最小）
inclination_weight = 0.01
# 最大影响距离（超过此距离，断层无影响）
max_influence_distance = 50.0


[RegionalMeasureParams]
# 吨煤钻孔量计算配置（替换原措施权重/修正系数）
# 默认煤密度（吨/立方米，参考煤矿常见值）
default_coal_density = 1.4
# 最小煤量阈值（避免除以零，单位：吨）
min_coal_quantity = 0.001
# 参考标准：《煤矿井下瓦斯抽采工程设计规范》（吨煤钻孔量≥0.05m/t为有效措施）